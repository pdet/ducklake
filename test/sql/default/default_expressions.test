# name: test/sql/default/default_expressions.test
# description: Test adding a column with default expression with DuckLake
# group: [default]

require ducklake

require parquet

require icu

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/default_expressions', METADATA_CATALOG 'xx')

statement ok
use ducklake

statement ok
create table t (id integer, created_at timestamp default now());

statement ok
insert into t(id) values(1);

query I
select created_at < NOW() from t;
----
true

statement ok
CREATE TABLE t0(c0 BOOLEAN DEFAULT(true), c1 VARCHAR);

statement ok
insert into t0(c1) values ('bla')

query II
FROM t0;
----
true	bla

statement ok
CREATE TABLE t2(l0 BOOLEAN DEFAULT(NULL), l1 VARCHAR);

statement ok
insert into t2(l0) values (true)

# query IIIIIIIIIIIIIII
# FROM xx.ducklake_column
# ----
# 1	1	NULL	1	1	id	int32	NULL	NULL	true	NULL	literal	duckdb	literal	duckdb
# 2	1	NULL	1	2	created_at	timestamp	now()	now()	true	NULL	expression	duckdb	expression	duckdb
# 1	3	NULL	2	1	c0	boolean	CAST('t' AS BOOLEAN)	CAST('t' AS BOOLEAN)	true	NULL	literal	duckdb	literal	duckdb
# 2	3	NULL	2	2	c1	varchar	NULL	NULL	true	NULL	literal	duckdb	literal	duckdb

statement ok
CREATE TABLE tbl(
    d DATE DEFAULT CURRENT_DATE,
    t TIME WITH TIME ZONE DEFAULT CURRENT_TIME,
    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cur_user VARCHAR DEFAULT CURRENT_USER,
    "user" VARCHAR DEFAULT USER,
    sess_user VARCHAR DEFAULT SESSION_USER,
    cur_catalog VARCHAR DEFAULT CURRENT_CATALOG,
    cur_schema VARCHAR DEFAULT CURRENT_SCHEMA
);
