# name: test/sql/update/update_join_duplicates.test
# description: Test ducklake update using a join with duplicates
# group: [update]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_update_join_files')

statement ok
CREATE TABLE ducklake.test AS SELECT i id FROM range(5) t(i);

# Source table with duplicate update_ids (each value appears twice)
statement ok
CREATE TEMPORARY TABLE updated_rows AS FROM range(0, 10, 2) t(update_id) UNION ALL FROM range(0, 10, 2);

# duplicate row-id updates now succeed with first-write-wins semantics
statement ok
BEGIN

statement ok
INSERT INTO ducklake.test FROM range(5, 10)

# This UPDATE has duplicates in the source - same row matched multiple times
# With first-write-wins, only the first match is applied
statement ok
UPDATE ducklake.test SET id=id+1000 FROM updated_rows WHERE id=updated_rows.update_id

query III
SELECT COUNT(*), SUM(id), AVG(id) FROM ducklake.test
----
10	5045	504.5

statement ok
COMMIT

# Verify data persists after commit
query III
SELECT COUNT(*), SUM(id), AVG(id) FROM ducklake.test
----
10	5045	504.5

# Using DISTINCT still works (and gives same result)
statement ok
DROP TABLE ducklake.test

statement ok
CREATE TABLE ducklake.test AS SELECT i id FROM range(5) t(i);

statement ok
INSERT INTO ducklake.test FROM range(5, 10)

statement ok
UPDATE ducklake.test SET id=id+1000 FROM (SELECT DISTINCT update_id FROM updated_rows) updated_rows WHERE id=updated_rows.update_id

query III
SELECT COUNT(*), SUM(id), AVG(id) FROM ducklake.test
----
10	5045	504.5

# Test with many duplicates to exercise the all-duplicates early return path
# 10000 matches for 1 row spans multiple chunks, later chunks are all duplicates
statement ok
DROP TABLE ducklake.test

statement ok
CREATE TABLE ducklake.test AS SELECT 1 as id

statement ok
CREATE TEMPORARY TABLE dup_source AS SELECT 1 as update_id FROM range(10000)

# despite 10000 source matches, only 1 row should be updated (deduplication)
query I
UPDATE ducklake.test SET id=id+1000 FROM dup_source WHERE id=dup_source.update_id
----
1

query I
SELECT id FROM ducklake.test
----
1001
