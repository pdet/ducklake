# name: test/sql/compaction/merge_adjacent_max_files.test
# description: test ducklake merge adjacent files max_files options
# group: [compaction]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/merge_adjacent_max_files/')

statement ok
USE ducklake;

statement ok
CREATE TABLE example (key integer);

# Generate 100 files
loop i 0 20

statement ok
INSERT INTO example VALUES (${i});

endloop

query I
SELECT count(*) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
20

statement error
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>-1);
----
Type INT32 with value -1 can't be cast

statement error
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>NULL);
----
The max_compacted_files option must be a non-null integer

statement error
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>0);
----
The max_compacted_files option must be greater than one.

query I
SELECT count(*) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
20

query II
SELECT max(data_file_id), min (data_file_id) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
19	0

# One file doesn't make much difference
statement error
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1);
----
The max_compacted_files option must be greater than one.

statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>2);

# We remove two files, and create a new one
query II
SELECT max(data_file_id), min (data_file_id) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
20	2

statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>10);

# We remove ten files, and create a new one
query II
SELECT max(data_file_id), min (data_file_id) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
21	11

statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>5);

# We remove five files, and create a new one
query II
SELECT max(data_file_id), min (data_file_id) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
22	15

# We end up with one file
statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1000);

query II
SELECT max(data_file_id), min (data_file_id) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
23	23

# It is safe to call it again
statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1000);

query II
SELECT max(data_file_id), min (data_file_id) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
23	23